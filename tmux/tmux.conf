#
# This is a configuration file for tmux.
# Document: https://github.com/tmux/tmux/wiki/Getting-Started#the-configuration-file
#
# Optimized for: macOS/Linux, Ghostty, Neovim, SSH/Remote
#

# == General ===================================================================

set -g prefix C-a                         # set the prefix key to Ctrl+a
unbind C-b                               # unbind the default prefix key (Ctrl+b)
bind C-a send-prefix                      # send Ctrl+a to applications by pressing it twice

# -- Terminal & Colors (Ghostty/Neovim optimized) ------------------------------

# Set default terminal type
set -g default-terminal "$TERM"

# True color support for Ghostty and modern terminals
set -ga terminal-overrides ",xterm-ghostty:Tc:clipboard"
set -ga terminal-overrides ",*256col*:Tc,alacritty:Tc,xterm-kitty:Tc"

# RGB and undercurl support (required for Neovim)
set -ga terminal-features ",xterm-ghostty:RGB:usstyle"
set -ga terminal-features ",*256col*:RGB,alacritty:RGB:usstyle,xterm-kitty:RGB:usstyle"

# -- Performance ---------------------------------------------------------------

setw -g xterm-keys on
set -s escape-time 0                      # Critical: eliminate ESC delay for Neovim
set -sg repeat-time 500
set -s focus-events on                    # Required for Neovim autoread

set -g history-limit 50000

# -- Clipboard (OSC 52 - works over SSH) ---------------------------------------

set -g set-clipboard on
set -g allow-passthrough on               # Allow apps to send OSC sequences directly

# -- Mouse ---------------------------------------------------------------------

set -g mouse on

# == Display ===================================================================

set -g base-index 1
setw -g pane-base-index 1

setw -g automatic-rename on
set -g renumber-windows on

set -g set-titles on
set -g set-titles-string "#{?SSH_CONNECTION,ğŸŒ ,}#S:#W"

set -g display-panes-time 800
set -g display-time 2000
set -g status-interval 3

# == Status Bar ================================================================

# Design principles:
# - Local: transparent background, blends with terminal
# - Remote/SSH: subtle background color for visual distinction
# - Icons and separators for visual structure
# - High contrast text for readability

set -g status-position bottom
set -g status-justify left
set -g status-left-length 50
set -g status-right-length 80

# -- Local (transparent) vs Remote (with background) ---------------------------

# Default: local style (transparent)
set -g status-style "bg=default,fg=#839496"
set -g pane-border-style "fg=#3c4c55"
set -g pane-active-border-style "fg=#268bd2"
set -g message-style "bg=default,fg=#b58900,bold"
set -g message-command-style "bg=default,fg=#268bd2"

# Remote/SSH: apply background color for visual distinction
if-shell '[ -n "$SSH_CONNECTION" ]' {
    set -g status-style "bg=#073642,fg=#839496"
    set -g pane-border-style "fg=#073642"
    set -g pane-active-border-style "fg=#268bd2"
    set -g message-style "bg=#073642,fg=#b58900,bold"
    set -g message-command-style "bg=#073642,fg=#268bd2"
}

# -- Status left ---------------------------------------------------------------

# Prefix indicator + session/hostname
# Local: session name
# Remote: globe icon + hostname
set -g status-left "\
#{?client_prefix,#[fg=#b58900]ó°ŒŒ ,#[fg=#586e75] }\
#[fg=#268bd2,bold]#{?SSH_CONNECTION,ó°–Ÿ #{host_short},#S}#[fg=default,nobold] #[fg=#3c4c55]â”‚ "

# -- Status right --------------------------------------------------------------

# Pane sync indicator + user@host (SSH only) + datetime
set -g status-right "\
#{?pane_synchronized,#[fg=#cb4b16]ó°“¦ sync ,}\
#{?SSH_CONNECTION,#[fg=#586e75]#{user}@#{host_short} #[fg=#3c4c55]â”‚ ,}\
#[fg=#586e75]%m-%d #[fg=#839496]%H:%M "

# -- Window list ---------------------------------------------------------------

# Inactive: dimmed, Active: cyan, Activity: yellow, Zoomed: icon
set -g window-status-format "#[fg=#586e75] #I:#W "
set -g window-status-current-format "#[fg=#2aa198,bold] #I:#W#{?window_zoomed_flag, ó°Š“,}#[fg=#2aa198] "
set -g window-status-separator "#[fg=#3c4c55]Â·"
set -g window-status-activity-style "fg=#b58900,none"
set -g window-status-bell-style "fg=#dc322f,none"

# -- Other display settings ----------------------------------------------------

# Activity monitoring
set -g monitor-activity on
set -g visual-activity off

# Pane borders
set -g pane-border-lines single
set -g pane-border-indicators colour

# Copy mode highlight
set -g mode-style "bg=#073642,fg=#b58900"

# == Window Management =========================================================

bind c new-window -c '#{pane_current_path}'
bind n new-window -c '#{pane_current_path}'

bind v split-window -h -c '#{pane_current_path}'
bind | split-window -h -c '#{pane_current_path}'
bind b split-window -v -c '#{pane_current_path}'
bind - split-window -v -c '#{pane_current_path}'

# Popup terminal (centered, large)
bind p display-popup -d '#{pane_current_path}' -w 85% -h 85% -E "$SHELL"

# Swap window position
bind -n S-Left swap-window -d -t -1
bind -n S-Right swap-window -d -t +1

# Pane navigation (Alt + arrow keys)
bind -n M-Up select-pane -U
bind -n M-Down select-pane -D
bind -n M-Left select-pane -L
bind -n M-Right select-pane -R

# Vim-style pane navigation
bind -r k select-pane -U
bind -r j select-pane -D
bind -r h select-pane -L
bind -r l select-pane -R

# Swap panes
bind > swap-pane -D
bind < swap-pane -U

# Resize panes
bind -r K resize-pane -U 3
bind -r J resize-pane -D 3
bind -r H resize-pane -L 5
bind -r L resize-pane -R 5

# Window navigation
bind -r C-h previous-window
bind -r C-l next-window
bind Tab last-window

# Quick window jump (Alt + number)
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9

# == Copy Mode (Vi style) ======================================================

set-window-option -g mode-keys vi

bind Enter copy-mode

bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi C-v send -X rectangle-toggle
bind -T copy-mode-vi Escape send -X cancel
bind -T copy-mode-vi H send -X start-of-line
bind -T copy-mode-vi L send -X end-of-line

# Copy to system clipboard (using OSC 52, works over SSH)
# Prefer OSC 52, fallback to system commands
bind -T copy-mode-vi y send -X copy-pipe-and-cancel
bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel

# macOS specific
if-shell "uname | grep -q Darwin" {
    bind -T copy-mode-vi y send -X copy-pipe-and-cancel "pbcopy"
    bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel "pbcopy"
}

# Linux (X11/Wayland)
if-shell "uname | grep -q Linux && command -v xclip" {
    bind -T copy-mode-vi y send -X copy-pipe-and-cancel "xclip -selection clipboard"
    bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel "xclip -selection clipboard"
}

if-shell "uname | grep -q Linux && command -v wl-copy" {
    bind -T copy-mode-vi y send -X copy-pipe-and-cancel "wl-copy"
    bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel "wl-copy"
}

# == SSH/Remote & Nested Tmux ==================================================

# Detect if running in SSH
# SSH_CONNECTION is set in SSH sessions

# Nested tmux support: press F12 to toggle inner/outer tmux
# After pressing F12, outer tmux passes all keys to inner tmux
# Visual: status bar dims and shows "OFF" indicator

# Disable outer tmux (F12 in normal mode)
bind -T root F12 \
    set prefix None \; \
    set key-table off \; \
    set status-left "#[fg=#3c4c55,dim]ó°’² OFF #[fg=#3c4c55]â”‚ " \; \
    set window-status-current-format "#[fg=#3c4c55,dim] #I:#W " \; \
    set window-status-format "#[fg=#3c4c55,dim] #I:#W " \; \
    if -F '#{pane_in_mode}' 'send-keys -X cancel' \; \
    refresh-client -S

# Re-enable outer tmux (F12 in off mode)
# Use run-shell to re-apply SSH-aware styles
bind -T off F12 \
    set -u prefix \; \
    set -u key-table \; \
    set -u status-left \; \
    set -u window-status-current-format \; \
    set -u window-status-format \; \
    run-shell 'if [ -n "$SSH_CONNECTION" ]; then \
        tmux set -g status-style "bg=#073642,fg=#839496"; \
    else \
        tmux set -g status-style "bg=default,fg=#839496"; \
    fi' \; \
    refresh-client -S

# When outer tmux is disabled:
# - Status bar text becomes very dim
# - Left shows "OFF" indicator
# - All keys pass through to inner tmux

# Quick SSH to remote with auto attach/create tmux
bind S command-prompt -p "SSH to:" "new-window -n '%1' 'ssh %1 -t \"tmux new -A -s default\"'"

# == Utilities =================================================================

# Reload configuration
bind r source-file ~/.tmux.conf \; display-message "  Config reloaded"

# Sync input to all panes
bind s setw synchronize-panes \; display-message "  Sync #{?synchronize-panes,ON,OFF}"

# Maximize/restore pane
bind m resize-pane -Z

# Quick close
bind x kill-pane
bind X kill-window

# Session management
bind C-n new-session
bind C-s choose-session

# Quick edit config
bind e new-window -n "tmux.conf" "nvim ~/.tmux.conf"

# Clear history and screen
bind C-k send-keys -R \; clear-history \; display-message "  Cleared"
